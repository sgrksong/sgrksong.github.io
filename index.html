<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>にじさんじ所属 司賀りこ 歌まとめ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .fade-in {
      animation: fadeIn 0.4s ease-out both;
    }
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .card {
      transition: transform 0.3s, box-shadow 0.3s;
    }

    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0px 4px 20px rgba(0, 0, 0, 0.1);
    }
  </style>
</head>
<body class="bg-white text-gray-800">
  <div class="max-w-4xl mx-auto px-4 py-8">
    <h1 class="text-3xl font-bold text-center mb-8">司賀りこ 歌まとめ</h1>
    
    <!-- 検索ボックス -->
    <div class="flex justify-between mb-4">
      <input id="searchInput" type="text" class="border p-2 w-full max-w-xs" placeholder="曲名やアーティストで検索">
      <button id="sortButton" class="ml-4 px-4 py-2 border rounded bg-blue-500 text-white">公開日で並び替え</button>
    </div>
    
    <!-- フィルター -->
    <div class="flex gap-4 mb-4">
      <div class="flex items-center gap-2">
        <label for="categoryFilter" class="text-sm">カテゴリ:</label>
        <select id="categoryFilter" class="border p-2">
          <option value="">すべて</option>
          <option value="あやかき">あやかき</option>
          <option value="ソロ">ソロ</option>
          <option value="コラボ">コラボ</option>
        </select>
      </div>
      
      <div class="flex items-center gap-2">
        <label for="videoTypeFilter" class="text-sm">動画種別:</label>
        <select id="videoTypeFilter" class="border p-2">
          <option value="">すべて</option>
          <option value="通常">通常</option>
          <option value="Shorts">Shorts</option>
          <option value="Tiktok動画">Tiktok動画</option>
        </select>
      </div>
    </div>
    
    <!-- 動画リスト -->
    <div id="videoList" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"></div>
  </div>

  <template id="videoPlayerTemplate">
    <div class="video-player-container w-full mt-4 fade-in">
      <div class="bg-black rounded-xl overflow-hidden shadow-lg">
        <iframe class="w-full aspect-video" src="" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
      </div>
    </div>
  </template>

  <div id="musicPlayer" class="fixed bottom-0 left-0 w-full bg-white border-t shadow z-50 px-4 py-2 flex flex-col gap-1 sm:flex-row sm:items-center sm:justify-between">
    <div class="flex items-center gap-4">
      <button id="prevBtn" class="text-gray-700 hover:text-blue-600">⏮️</button>
      <button id="playBtn" class="text-gray-700 hover:text-blue-600">▶️</button>
      <button id="nextBtn" class="text-gray-700 hover:text-blue-600">⏭️</button>
    </div>
    <div class="text-xs text-gray-600 text-center">
      <div id="nowPlaying" class="truncate">🎵 再生中: -</div>
      <div id="nextUp" class="truncate">🎶 次: -</div>
    </div>
    <div class="flex items-center gap-3">
      <button id="shuffleToggleBtn" class="text-gray-400 hover:text-blue-500 transition">
        🔀
      </button>
      <button id="repeatToggleBtn" class="text-gray-400 hover:text-blue-500 transition">
        🔁
      </button>
    </div>
  </div>

  <script>
    const sheetJsonUrl = 'https://opensheet.elk.sh/1sZGH3TGYdC5UShrIEFEe2T8-axXEFet6qsxbqCoHX5o/%E3%82%B7%E3%83%BC%E3%83%881';
    let allVideos = [];
    let currentIndex = -1;

    // 動画リストを表示
    function renderVideoList(videos) {
      const videoList = document.getElementById('videoList');
      videoList.innerHTML = '';

      // 検索とフィルタリング機能を適用した動画表示
      const searchInput = document.getElementById('searchInput').value.toLowerCase();
      const categoryFilter = document.getElementById('categoryFilter').value;
      const videoTypeFilter = document.getElementById('videoTypeFilter').value;

      const filteredVideos = videos.filter(video => {
        const matchesSearch = video["title"].toLowerCase().includes(searchInput) || video["artist"].toLowerCase().includes(searchInput);
        const matchesCategory = categoryFilter ? video["カテゴリ"] === categoryFilter : true;
        const matchesVideoType = videoTypeFilter ? video["動画種別"] === videoTypeFilter : true;
        return matchesSearch && matchesCategory && matchesVideoType;
      });

      filteredVideos.forEach((video, index) => {
        const item = document.createElement('div');
        item.className = 'card p-4 bg-white border border-gray-200 rounded-lg shadow-md hover:shadow-xl transition-all';

        const title = document.createElement('a');
        title.href = '#';
        title.className = 'text-blue-600 font-semibold hover:underline';
        title.textContent = `${video["title"]} - ${video["artist"]}`;
        title.onclick = e => {
          e.preventDefault();
          loadVideoByIndex(index);
        };

        const meta = document.createElement('div');
        meta.className = 'text-sm text-gray-500 mt-2';
        meta.innerHTML = `カテゴリ: ${video["カテゴリ"]} / 公開日: ${video["公開日"]} / 種別: ${video["動画種別"]} / 担当: ${video["担当区分"]}`;

        const cardBody = document.createElement('div');
        cardBody.className = 'flex flex-col gap-2';
        cardBody.appendChild(title);
        cardBody.appendChild(meta);
        item.appendChild(cardBody);

        videoList.appendChild(item);
      });
    }

    // 動画データをロード
    function loadVideo(video, container) {
      const start = parseInt(video["start"] || '0');
      let videoId = video["videoId"];
      const platform = video["platform"];
      let embedUrl = '';

      if (!videoId) return alert("videoId が指定されていません");

      if (platform.toLowerCase().includes("youtube")) {
        const match = videoId.match(/(?:v=|\/|youtu\.be\/)?([0-9A-Za-z_-]{11})/);
        if (match) videoId = match[1];
        embedUrl = `https://www.youtube.com/embed/${videoId}?start=${start}&autoplay=1&enablejsapi=1&origin=${location.origin}`;
      } else if (platform.toLowerCase() === 'tiktok') {
        const match = videoId.match(/video\/(\d+)/);
        const tiktokId = match ? match[1] : videoId;
        embedUrl = `https://www.tiktok.com/embed/v2/${tiktokId}`;
      }

      document.querySelectorAll('.video-player-container').forEach(el => el.remove());
      const template = document.getElementById('videoPlayerTemplate').content.cloneNode(true);
      template.querySelector('iframe').src = embedUrl;
      container.appendChild(template);
    }

    // インデックス番号で動画を表示
    function loadVideoByIndex(index) {
      const videos = document.querySelectorAll('#videoList > div');
      if (index < 0 || index >= videos.length) return;
      const title = videos[index].querySelector('a').textContent;
      let nextTitle = '-';

      const isShuffle = document.getElementById('shuffleToggle').checked;
      if (isShuffle) {
        let next;
        do {
          next = Math.floor(Math.random() * videos.length);
        } while (next === index);
        nextTitle = videos[next]?.querySelector('a')?.textContent || '-';
      } else {
        const nextIndex = (index + 1 < videos.length) ? index + 1 : (document.getElementById('repeatToggle').checked ? 0 : -1);
        if (nextIndex !== -1) {
          nextTitle = videos[nextIndex]?.querySelector('a')?.textContent || '-';
        }
      }

      updateNowNextDisplay(videos, title, nextTitle);

      const video = allVideos[index];
      const container = videos[index];
      loadVideo(video, container);

      currentIndex = index;
    }

    // 次の動画を再生
    function playNext() {
      const isShuffle = document.getElementById('shuffleToggle').checked;
      const videos = document.querySelectorAll('#videoList > div');
      if (isShuffle) {
        let next;
        do {
          next = Math.floor(Math.random() * videos.length);
        } while (next === currentIndex);
        loadVideoByIndex(next);
      } else {
        let nextIndex = currentIndex + 1;
        if (nextIndex >= videos.length) {
          if (document.getElementById('repeatToggle').checked) {
            nextIndex = 0;
          } else {
            updateNowNextDisplay(videos, videos[currentIndex]?.querySelector('a')?.textContent, null);
            return;
          }
        }
        loadVideoByIndex(nextIndex);
      }
    }

    // 初期データのロード
    window.addEventListener('DOMContentLoaded', () => {
      fetch(sheetJsonUrl)
        .then(response => response.json())
        .then(data => {
          allVideos = data;  // スプレッドシートからのデータを格納
          renderVideoList(data);  // リストを表示
        });
    });

    // 検索のイベント
    document.getElementById('searchInput').addEventListener('input', () => {
      renderVideoList(allVideos);
    });

    // フィルターのイベント
    document.getElementById('categoryFilter').addEventListener('change', () => {
      renderVideoList(allVideos);
    });
    document.getElementById('videoTypeFilter').addEventListener('change', () => {
      renderVideoList(allVideos);
    });

    // 並び替えボタンのイベント
    document.getElementById('sortButton').addEventListener('click', () => {
      allVideos.sort((a, b) => new Date(b["公開日"]) - new Date(a["公開日"]));
      renderVideoList(allVideos);
    });
  </script>
</body>
</html>
